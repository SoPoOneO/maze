<html>
	<head>
		<script src="js/jquery.js"></script>
		<script>
			var config = {
				width: 80,
				height: 40,
				delay: 50
			};
		
			$("document").ready(function(){
				build_table();
				$("#out td").click(start_maze);
			});
			
			function build_table(){
				for(var i=0; i<config.height; i++){
					var tr = $("<tr></tr>");
					for(var j=0; j<config.width; j++){
						var td = $("<td></td>");
						td.data("tile", false);
						tr.append(td);
					}
					$("#out tbody").append(tr);
				}
			}
		
			function start_maze(){
				var coords = coords_from_td(this);
				var start = ['t', 'r', 'b', 'l'][rand(4)];
				place_tile(coords, start);
			}
			
			function place_tile(coords, start){
				
				// if it's outside the range
				if(coords.x<0 || coords.x>=config.width || coords.y<0 || coords.y>=config.height){
					end_maze('out of bounds');
					return false;
				}
			
				// get the td we're entering
				var td = td_from_coords(coords);
			
				// if that td is already taken
				next = false;
				if(td.data("tile")){
					var current_tile = td.data("tile");
					if(current_tile.img == "img/vert.png" && (start == 'l' || start == 'r')){
						next = cross[start];
					}
					if(current_tile.img == "img/hori.png" && (start == 't' || start == 'b')){
						next = cross[start];
					}
					if(!next){
						end_maze('no next');
						return false;
					}
				}
				
				if(next){
					var options = [next];
				}
				
				else{
					// figure out which options won't collide
					var options = new Array();
					for(var i=0; i<3; i++){
						var tile = tiles[start][i];
						var next_coords = {
							x: coords.x + tile.dx,
							y: coords.y + tile.dy
						};
						var next_td = td_from_coords(next_coords);
						if(next_coords.x>=0 && next_coords.x<config.width && next_coords.y>=0 && next_coords.y<config.height){
						
							// if the next one is blank
							if(!next_td.data("tile")){
								options.push(tile);
							}
							
							// of it the next is a line that you will cross
							if(next_td.data("tile").img == "img/vert.png" && (tile.end == 'l' || tile.end == 'r')){
								options.push(tile);
							}
							if(next_td.data("tile").img == "img/hori.png" && (tile.end == 't' || tile.end == 'b')){
								options.push(tile);
							}
						}
					}
				}
				
				if(!options.length){
					end_maze('no options');
					return false;
				}
				
				var tile = options[rand(options.length)];
				
				td.data("tile", tile);
				td.css("background", "url('"+tile.img+"')");
				
				// set up the next round
				var next_coords = {
					x: coords.x + tile.dx,
					y: coords.y + tile.dy
				};
				
				setTimeout(
					function(){place_tile(next_coords, tile.next_start)},
					config.delay
				);
			}
			
			function end_maze(message){
				console.log(message);
			}
			
			function rand(max){
				return Math.floor(Math.random() * max);
			}
			
			function td_from_coords(coords){
				var tr = $("#out tbody tr")[coords.y];
				var td = $(tr).find("td")[coords.x];
				return $(td);
			}
			
			function coords_from_td(td){
				return {x: td.cellIndex, y: td.parentNode.rowIndex};
			}
			
			function tile(img, start, end, dx, dy, next_start){
				this.img 		= img;
				this.start 		= start;
				this.end 		= end;
				this.dx			= dx;
				this.dy			= dy;
				this.next_start	= next_start;
			}
			
			var tiles = new Array();
			tiles['t'] = [
				new tile('img/tr.png', 't', 'r', 1, 0, 'l'),
				new tile('img/vert.png', 't', 'b', 0, 1, 't'),
				new tile('img/tl.png', 't', 'l', -1, 0, 'r')
			];
			
			tiles['r'] = [
				new tile('img/tr.png', 'r', 't', 0, -1, 'b'),
				new tile('img/hori.png', 'r', 'l', -1, 0, 'r'),
				new tile('img/br.png', 'r', 'b', 0, 1, 't')
			];
			tiles['b'] = [
				new tile('img/br.png', 'b', 'r', 1, 0, 'l'),
				new tile('img/vert.png', 'b', 't', 0, -1, 'b'),
				new tile('img/bl.png', 'b', 'l', -1, 0, 'r')
			];
			tiles['l'] = [
				new tile('img/tl.png', 'l', 't', 0, -1, 'b'),
				new tile('img/hori.png', 'l', 'r', 1, 0, 'l'),
				new tile('img/bl.png', 'l', 'b', 0, 1, 't')
			];
			
			var cross = new Array();
			cross['t'] = new tile('img/cross.png', 't', 'b', 0, 1, 't');
			cross['r'] = new tile('img/cross.png', 'r', 'l', -1, 0, 'r');
			cross['b'] = new tile('img/cross.png', 'b', 't', 0, -1, 'b');
			cross['l'] = new tile('img/cross.png', 'l', 'r', 1, 0, 'l');
		
		</script>
		<style>
			#out{
				border-collapse:collapse;
			}
		
			#out tbody tr td{
				border: 0px solid black;
				width: 15px;
				height: 15px;
				padding: 0px;
				margin: 0px;
			}
	
		</style>
	</head>
	<body>
		<table id="out">
			<tbody>
			
		
		
			</tbody>
		</table>
	
	
	
	
	</body>
</html>